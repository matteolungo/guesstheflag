const json = {
    "ad": "Andorra",
    "ae": "Emirati Arabi Uniti",
    "af": "Afghanistan",
    "ag": "Antigua e Barbuda",
    "ai": "Anguilla",
    "al": "Albania",
    "am": "Armenia",
    "ao": "Angola",
    "aq": "Antartide",
    "ar": "Argentina",
    "as": "Samoa Americane",
    "at": "Austria",
    "au": "Australia",
    "aw": "Aruba",
    "ax": "Isole Aland",
    "az": "Azerbaigian",
    "ba": "Bosnia ed Erzegovina",
    "bb": "Barbados",
    "bd": "Bangladesh",
    "be": "Belgio",
    "bf": "Burkina Faso",
    "bg": "Bulgaria",
    "bh": "Bahrein",
    "bi": "Burundi",
    "bj": "Benin",
    "bl": "Saint-Barthélemy",
    "bm": "Bermuda",
    "bn": "Brunei",
    "bo": "Bolivia",
    "bq": "Paesi Bassi caraibici",
    "br": "Brasile",
    "bs": "Bahamas",
    "bt": "Bhutan",
    "bw": "Botswana",
    "by": "Bielorussia",
    "bz": "Belize",
    "ca": "Canada",
    "cc": "Isole Cocos",
    "cd": "Congo (Rep. Dem.)",
    "cf": "Repubblica Centrafricana",
    "cg": "Congo",
    "ch": "Svizzera",
    "ci": "Costa d'Avorio",
    "ck": "Isole Cook",
    "cl": "Cile",
    "cm": "Camerun",
    "cn": "Cina",
    "co": "Colombia",
    "cr": "Costa Rica",
    "cu": "Cuba",
    "cv": "Capo Verde",
    "cw": "Curaçao",
    "cx": "Isola di Natale",
    "cy": "Cipro",
    "cz": "Repubblica Ceca",
    "de": "Germania",
    "dj": "Gibuti",
    "dk": "Danimarca",
    "dm": "Dominica",
    "do": "Repubblica Dominicana",
    "dz": "Algeria",
    "ec": "Ecuador",
    "ee": "Estonia",
    "eg": "Egitto",
    "eh": "Sahara Occidentale",
    "er": "Eritrea",
    "es": "Spagna",
    "et": "Etiopia",
    "fi": "Finlandia",
    "fj": "Figi",
    "fk": "Isole Falkland",
    "fm": "Micronesia",
    "fo": "Far Oer",
    "fr": "Francia",
    "ga": "Gabon",
    "gb": "Regno Unito",
    "gb-eng": "Inghilterra",
    "gb-nir": "Irlanda del Nord",
    "gb-sct": "Scozia",
    "gb-wls": "Galles",
    "gd": "Grenada",
    "ge": "Georgia",
    "gf": "Guyana francese",
    "gg": "Guernsey",
    "gh": "Ghana",
    "gi": "Gibilterra",
    "gl": "Groenlandia",
    "gm": "Gambia",
    "gn": "Guinea",
    "gp": "Guadalupa",
    "gq": "Guinea Equatoriale",
    "gr": "Grecia",
    "gs": "Georgia del Sud e Isole Sandwich Australi",
    "gt": "Guatemala",
    "gu": "Guam",
    "gw": "Guinea-Bissau",
    "gy": "Guyana",
    "hk": "Hong Kong",
    "hn": "Honduras",
    "hr": "Croazia",
    "ht": "Haiti",
    "hu": "Ungheria",
    "id": "Indonesia",
    "ie": "Irlanda",
    "il": "Israele",
    "im": "Isola di Man",
    "in": "India",
    "io": "Territorio britannico dell'Oceano Indiano",
    "iq": "Iraq",
    "ir": "Iran",
    "is": "Islanda",
    "it": "Italia",
    "je": "Baliato di Jersey",
    "jm": "Giamaica",
    "jo": "Giordania",
    "jp": "Giappone",
    "ke": "Kenya",
    "kg": "Kirghizistan",
    "kh": "Cambogia",
    "ki": "Kiribati",
    "km": "Comore",
    "kn": "Saint Kitts e Nevis",
    "kp": "Corea del Nord",
    "kr": "Corea del Sud",
    "kw": "Kuwait",
    "ky": "Isole Cayman",
    "kz": "Kazakistan",
    "la": "Laos",
    "lb": "Libano",
    "lc": "Santa Lucia",
    "li": "Liechtenstein",
    "lk": "Sri Lanka",
    "lr": "Liberia",
    "ls": "Lesotho",
    "lt": "Lituania",
    "lu": "Lussemburgo",
    "lv": "Lettonia",
    "ly": "Libia",
    "ma": "Marocco",
    "mc": "Principato di Monaco",
    "md": "Moldavia",
    "me": "Montenegro",
    "mg": "Madagascar",
    "mh": "Isole Marshall",
    "mk": "Macedonia del Nord",
    "ml": "Mali",
    "mm": "Birmania",
    "mn": "Mongolia",
    "mo": "Macao",
    "mp": "Isole Marianne Settentrionali",
    "mq": "Martinica",
    "mr": "Mauritania",
    "ms": "Montserrat",
    "mt": "Malta",
    "mu": "Mauritius",
    "mv": "Maldive",
    "mw": "Malawi",
    "mx": "Messico",
    "my": "Malesia",
    "mz": "Mozambico",
    "na": "Namibia",
    "nc": "Nuova Caledonia",
    "ne": "Niger",
    "nf": "Isola Norfolk",
    "ng": "Nigeria",
    "ni": "Nicaragua",
    "nl": "Paesi Bassi",
    "no": "Norvegia",
    "np": "Nepal",
    "nr": "Nauru",
    "nu": "Niue",
    "nz": "Nuova Zelanda",
    "om": "Oman",
    "pa": "Panama",
    "pe": "Perù",
    "pf": "Polinesia francese",
    "pg": "Papua Nuova Guinea",
    "ph": "Filippine",
    "pk": "Pakistan",
    "pl": "Polonia",
    "pm": "Saint-Pierre e Miquelon",
    "pn": "Isole Pitcairn",
    "pr": "Porto Rico",
    "ps": "Palestina",
    "pt": "Portogallo",
    "pw": "Palau",
    "py": "Paraguay",
    "qa": "Qatar",
    "re": "Riunione",
    "ro": "Romania",
    "rs": "Serbia",
    "ru": "Russia",
    "rw": "Ruanda",
    "sa": "Arabia Saudita",
    "sb": "Isole Salomone",
    "sc": "Seychelles",
    "sd": "Sudan",
    "se": "Svezia",
    "sg": "Singapore",
    "sh": "Sant'Elena, Ascensione e Tristan da Cunha",
    "si": "Slovenia",
    "sk": "Slovacchia",
    "sl": "Sierra Leone",
    "sm": "San Marino",
    "sn": "Senegal",
    "so": "Somalia",
    "sr": "Suriname",
    "ss": "Sudan del Sud",
    "st": "São Tomé e Príncipe",
    "sv": "El Salvador",
    "sx": "Sint Maarten",
    "sy": "Siria",
    "sz": "Swaziland",
    "tc": "Turks e Caicos",
    "td": "Ciad",
    "tf": "Terre australi e antartiche francesi",
    "tg": "Togo",
    "th": "Thailandia",
    "tj": "Tagikistan",
    "tk": "Tokelau",
    "tl": "Timor Est",
    "tm": "Turkmenistan",
    "tn": "Tunisia",
    "to": "Tonga",
    "tr": "Turchia",
    "tt": "Trinidad e Tobago",
    "tv": "Tuvalu",
    "tw": "Taiwan",
    "tz": "Tanzania",
    "ua": "Ucraina",
    "ug": "Uganda",
    "uy": "Uruguay",
    "uz": "Uzbekistan",
    "va": "Città del Vaticano",
    "vc": "Saint Vincent e Grenadine",
    "ve": "Venezuela",
    "vg": "Isole Vergini britanniche",
    "vi": "Isole Vergini americane",
    "vn": "Vietnam",
    "vu": "Vanuatu",
    "wf": "Wallis e Futuna",
    "ws": "Samoa",
    "xk": "Kosovo",
    "ye": "Yemen",
    "yt": "Mayotte",
    "za": "Sudafrica",
    "zm": "Zambia",
    "zw": "Zimbabwe"
}

let score = 0;
let guessed = [];
let positions = []
let choices = [];
let seconds = 5;
const values = Object.values(json);
const keys = Object.keys(json);
let modalStart = new bootstrap.Modal(document.getElementById('modalStart'));
let modalEnd = new bootstrap.Modal(document.getElementById('modalEnd'));
let modalText = document.getElementById('modalText');
let randomKey, correctFlag, correctButton, lastPress, timer, interval, points;

function start() {
    modalStart.hide();
    let buttons = document.getElementsByClassName('button');
    for (const b of buttons) {
        b.style.visibility = 'visible';
    }
    let flag = document.getElementById('flag');
    flag.style.visibility = 'visible';
    newFlag();
}

function newFlag() {
    positions = [1, 2, 3, 4];
    choices = [];
    seconds = 5;

    document.getElementById('button1').disabled = false;
    document.getElementById('button2').disabled = false;
    document.getElementById('button3').disabled = false;
    document.getElementById('button4').disabled = false;
    document.getElementById('timer').innerHTML = 'Tempo: ' + seconds;
    document.getElementById('points').innerHTML = '';
    if (lastPress) {
        lastPress.className = 'btn border btn-lg button btn-light';
        correctButton.className = 'btn border btn-lg button btn-light';
    }
    do {
        randomKey = keys[parseInt(Math.random() * keys.length)];
    } while (guessed.includes(json[randomKey]))
    document.getElementById('flag').src = 'flags/' + randomKey + '.png';
    correctFlag = json[randomKey];
    choices.push(correctFlag);
    let randomPosition = parseInt(Math.random() * positions.length) + 1;
    positions = positions.filter(p => p !== randomPosition);
    correctButton = document.getElementById('button' + randomPosition);
    correctButton.innerHTML = correctFlag;

    while (choices.length < 4) {
        let randomValue = values[parseInt(Math.random() * values.length)];
        if (!choices.includes(randomValue)) {
            choices.push(randomValue);
            let randomPosition = positions[parseInt(Math.random() * positions.length)];
            positions = positions.filter(p => p !== randomPosition);
            document.getElementById('button' + randomPosition).innerHTML = randomValue;
        }
    }

    interval = setInterval(() => {
        seconds--;
        document.getElementById('timer').innerHTML = 'Tempo: ' + seconds;
    }, 1000);

    timer = setTimeout(() => {
        lose();
        clearInterval(interval);
    }, 5000);

}

function checkResult(event) {
    document.getElementById('button1').disabled = true;
    document.getElementById('button2').disabled = true;
    document.getElementById('button3').disabled = true;
    document.getElementById('button4').disabled = true;
    let answer = event.target.innerHTML;
    if (answer === correctFlag) {
        if (seconds > 4) {
            points = 3;
        } else if (seconds > 2) {
            points = 2;
        } else {
            points = 1;
        }
        guessed.push(correctFlag)
        score += points;
        document.getElementById('score').innerHTML = 'Punti: ' + score;
        document.getElementById('points').innerHTML = '+ ' + points;
        event.target.className = 'btn border btn-lg button btn-success';
        if (guessed.length === 248) {
            win();
        } else {
            let audio = new Audio('./res/correct.mp3');
            audio.play();
            setTimeout(() => { newFlag() }, 1000);
        }

    } else {
        event.target.className = 'btn border btn-lg button btn-danger'
        correctButton.className = 'btn border btn-lg button btn-success';
        lastPress = event.target;
        lose();
    }
    lastPress = event.target;
    clearTimeout(timer);
    clearInterval(interval);
}

function restart() {
    score = 0;
    document.getElementById('score').innerHTML = 'Punti: ' + score;
    guessed = [];
    modalEnd.hide();
    newFlag();
}

function lose() {
    let audio = new Audio('./res/lose.mp3');
    audio.play();
    modalText.innerHTML = `Hai perso!<br/>Hai totalizzato ${score} punti.`;
    modalEnd.toggle();
}

function win() {
    let audio = new Audio('./res/win.mp3');
    audio.play();
    modalText.innerHTML = `Hai vinto!<br/>Hai totalizzato ${score} punti.`;
    modalEnd.toggle();
}

window.onload = function main() {
    document.getElementById('button1').addEventListener('click', checkResult);
    document.getElementById('button2').addEventListener('click', checkResult);
    document.getElementById('button3').addEventListener('click', checkResult);
    document.getElementById('button4').addEventListener('click', checkResult);
    document.getElementById('restartButton').addEventListener('click', restart);
    document.getElementById('startButton').addEventListener('click', start);
    modalStart.toggle();
}

